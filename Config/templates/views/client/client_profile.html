<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Mi Perfil - FerreJunior</title>
    
    <!-- CSS -->
    <link href="{{ url_for('static', filename='vendor/fontawesome-free/css/all.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/sb-admin-2.min.css') }}" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/client_profile.css') }}" rel="stylesheet">
</head>

<body>
    <!-- Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <i class="fas fa-tools"></i>
                <span class="logo-text">FerreJunior</span>
            </div>
        </div>
        
        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="section-title">Principal</div>
                <div class="nav-item">
                    <a href="{{ url_for('client.client_dashboard') }}" class="nav-link">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="{{ url_for('client.client_profile') }}" class="nav-link active">
                        <i class="fas fa-user-circle"></i>
                        <span>Mi Perfil</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="{{ url_for('client.catalog') }}" class="nav-link">
                        <i class="fas fa-store"></i>
                        <span>Catálogo</span>
                    </a>
                </div>
            </div>

            <div class="nav-section">
                <div class="section-title">Compras</div>
                <div class="nav-item">
                    <a href="{{ url_for('client.client_orders') }}" class="nav-link">
                        <i class="fas fa-shopping-cart"></i>
                        <span>Mis Pedidos</span>
                        <span class="badge" id="orders-badge">0</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="{{ url_for('client.client_addresses') }}" class="nav-link">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>Mis Direcciones</span>
                    </a>
                </div>
            </div>

            <div class="nav-section">
                <div class="section-title">Soporte</div>
                <div class="nav-item">
                    <a href="#" class="nav-link" onclick="event.preventDefault(); showTab('support'); return false;">
                        <i class="fas fa-headset"></i>
                        <span>Centro de Ayuda</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" onclick="event.preventDefault(); showTab('support'); return false;">
                        <i class="fas fa-comments"></i>
                        <span>Contactar Soporte</span>
                    </a>
                </div>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Top Navigation Bar -->
        <div class="top-navbar">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('client.client_dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item active">Mi Perfil</li>
                </ol>
            </nav>
            
            <div class="user-menu">
                <button class="notification-btn">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge">2</span>
                </button>
                
                <div class="user-info" onclick="toggleUserMenu()">
                    <div class="user-avatar">
                        {{ current_user.name[0].upper() if current_user.name else 'C' }}
                    </div>
                    <div class="user-details">
                        <h6>{{ current_user.name or 'Cliente' }}</h6>
                        <small>{{ current_user.role.title() if current_user.role else 'Cliente' }}</small>
                    </div>
                    <i class="fas fa-chevron-down"></i>
                </div>
                
                <div class="dropdown-menu" id="userDropdown" style="display: none;">
                    <a class="dropdown-item" href="{{ url_for('client.client_profile') }}">
                        <i class="fas fa-user"></i> Mi Perfil
                    </a>
                    <a class="dropdown-item" href="{{ url_for('client.client_orders') }}">
                        <i class="fas fa-shopping-cart"></i> Mis Pedidos
                    </a>
                    <a class="dropdown-item" href="{{ url_for('client.client_addresses') }}">
                        <i class="fas fa-map-marker-alt"></i> Mis Direcciones
                    </a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="{{ url_for('auth.logout') }}">
                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                    </a>
                </div>
            </div>
        </div>

        <!-- Profile Content -->
        <div class="dashboard-content">
            <div class="page-header">
                <h1 class="page-title">Mi Perfil</h1>
                <p class="page-subtitle">Gestiona tu información personal y revisa tu historial de compras</p>
            </div>

            <div class="profile-container">
                <!-- Profile Sidebar -->
                <div class="profile-sidebar">
                    <div class="profile-avatar-section">
                        <div class="profile-avatar">
                            {{ current_user.name[0].upper() if current_user.name else 'C' }}
                        </div>
                        <h3 class="profile-name">{{ current_user.name or 'Cliente' }}</h3>
                        <p class="profile-role">{{ current_user.role.title() if current_user.role else 'Cliente Registrado' }}</p>
                    </div>

                    <div class="profile-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="total-orders">0</div>
                            <div class="stat-label">Pedidos Totales</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="total-spent">$0</div>
                            <div class="stat-label">Total Gastado</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="rating">N/A</div>
                            <div class="stat-label">Valoración</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="days-active">0</div>
                            <div class="stat-label">Días Activo</div>
                        </div>
                    </div>

                    <div class="profile-actions">
                        <button class="profile-btn primary" onclick="showTab('personal')">
                            <i class="fas fa-edit"></i> Editar Perfil
                        </button>
                        <button class="profile-btn secondary" onclick="showTab('purchases')">
                            <i class="fas fa-shopping-bag"></i> Mis Compras
                        </button>
                        <button class="profile-btn secondary" onclick="showTab('security')">
                            <i class="fas fa-shield-alt"></i> Seguridad
                        </button>
                    </div>
                </div>

                <!-- Profile Main Content -->
                <div class="profile-main">
                    <div class="profile-tabs">
                        <button class="tab-btn active" onclick="showTab('personal')">
                            <i class="fas fa-user"></i> Información Personal
                        </button>
                        <button class="tab-btn" onclick="showTab('purchases')">
                            <i class="fas fa-shopping-bag"></i> Historial de Compras
                        </button>
                        <button class="tab-btn" onclick="showTab('activity')">
                            <i class="fas fa-history"></i> Actividad
                        </button>
                        <button class="tab-btn" onclick="showTab('security')">
                            <i class="fas fa-shield-alt"></i> Seguridad
                        </button>
                        <button class="tab-btn" onclick="showTab('support')">
                            <i class="fas fa-headset"></i> Soporte
                        </button>
                    </div>

                    <!-- Personal Information Tab -->
                    <div id="tab-personal" class="tab-content active">
                        <form id="profileForm" action="{{ url_for('client.update_client_profile') }}" method="POST">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Nombre Completo</label>
                                    <input type="text" name="name" class="form-control" value="{{ current_user.name or '' }}" placeholder="Ingresa tu nombre completo">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email</label>
                                    <input type="email" name="email" class="form-control" value="{{ current_user.email or '' }}" placeholder="tu@email.com">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Tipo de Cliente</label>
                                    <input type="text" class="form-control" value="{{ current_user.role.title() if current_user.role else 'Cliente' }}" readonly>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Fecha de Registro</label>
                                    <input type="text" class="form-control" value="{{ current_user.created_at.strftime('%d/%m/%Y') if current_user.created_at else 'No disponible' }}" readonly>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Teléfono</label>
                                    <input type="tel" name="phone" class="form-control" placeholder="+1 (555) 123-4567">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Fecha de Nacimiento</label>
                                    <input type="date" name="birth_date" class="form-control">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Dirección</label>
                                <textarea name="address" class="form-control" rows="3" placeholder="Ingresa tu dirección completa..."></textarea>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Ciudad</label>
                                    <input type="text" name="city" class="form-control" placeholder="Ciudad">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Código Postal</label>
                                    <input type="text" name="postal_code" class="form-control" placeholder="12345">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Preferencias de Notificación</label>
                                <div style="display: flex; gap: 20px; margin-top: 10px;">
                                    <label style="display: flex; align-items: center; gap: 8px;">
                                        <input type="checkbox" name="email_notifications" checked>
                                        <span>Email</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px;">
                                        <input type="checkbox" name="sms_notifications">
                                        <span>SMS</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px;">
                                        <input type="checkbox" name="push_notifications" checked>
                                        <span>Push</span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-group">
                                <button type="submit" class="profile-btn primary">
                                    <i class="fas fa-save"></i> Guardar Cambios
                                </button>
                                <button type="reset" class="profile-btn secondary">
                                    <i class="fas fa-undo"></i> Descartar
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Purchases Tab -->
                    <div id="tab-purchases" class="tab-content">
                        <div class="performance-metrics">
                            <div class="metric-card">
                                <div class="metric-value" id="metric-total-orders">0</div>
                                <div class="metric-label">Pedidos Totales</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="metric-total-spent">$0</div>
                                <div class="metric-label">Total Gastado</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="metric-rating">N/A</div>
                                <div class="metric-label">Valoración Promedio</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="metric-satisfaction">0%</div>
                                <div class="metric-label">Satisfacción</div>
                            </div>
                        </div>

                        <div class="form-group" id="recent-orders-container">
                            <h4 style="margin-bottom: 20px;">Últimos Pedidos</h4>
                            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; text-align: center; color: #64748b;">
                                <i class="fas fa-spinner fa-spin" style="margin-right: 10px;"></i>
                                Cargando pedidos...
                            </div>
                        </div>

                        <div class="form-group">
                            <div style="background: #f8fafc; padding: 20px; border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <span>Productos Favoritos</span>
                                    <span style="color: #ff8559; font-weight: 600;">7 productos</span>
                                </div>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <span style="background: #e2e8f0; padding: 5px 10px; border-radius: 15px; font-size: 12px;">Taladros</span>
                                    <span style="background: #e2e8f0; padding: 5px 10px; border-radius: 15px; font-size: 12px;">Pinturas</span>
                                    <span style="background: #e2e8f0; padding: 5px 10px; border-radius: 15px; font-size: 12px;">Herramientas</span>
                                    <span style="background: #e2e8f0; padding: 5px 10px; border-radius: 15px; font-size: 12px;">Electricidad</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Activity Tab -->
                    <div id="tab-activity" class="tab-content">
                        <div class="activity-feed" id="activity-feed">
                            <div style="text-align: center; color: #64748b; padding: 40px;">
                                <i class="fas fa-spinner fa-spin" style="margin-right: 10px;"></i>
                                Cargando actividad...
                            </div>
                        </div>
                    </div>

                    <!-- Security Tab -->
                    <div id="tab-security" class="tab-content">
                        <div class="security-item">
                            <div class="security-info">
                                <h4>Cambiar Contraseña</h4>
                                <p>Última actualización hace 30 días</p>
                            </div>
                            <div class="security-status enabled">
                                <i class="fas fa-shield-alt"></i> Segura
                            </div>
                        </div>
                        
                        <div class="security-item">
                            <div class="security-info">
                                <h4>Autenticación de Dos Factores</h4>
                                <p>Protege tu cuenta con verificación adicional</p>
                            </div>
                            <div class="security-status disabled">
                                <i class="fas fa-times-circle"></i> Deshabilitada
                            </div>
                        </div>
                        
                        <div class="security-item">
                            <div class="security-info">
                                <h4>Métodos de Pago Guardados</h4>
                                <p>Tarjetas y métodos de pago seguros</p>
                            </div>
                            <div class="security-status enabled">
                                <i class="fas fa-credit-card"></i> 2 tarjetas
                            </div>
                        </div>
                        
                        <div class="security-item">
                            <div class="security-info">
                                <h4>Historial de Sesiones</h4>
                                <p>Revisa dispositivos conectados a tu cuenta</p>
                            </div>
                            <div class="security-status enabled">
                                <i class="fas fa-mobile-alt"></i> 1 dispositivo activo
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 30px;">
                            <button class="profile-btn primary" onclick="changePassword()">
                                <i class="fas fa-key"></i> Cambiar Contraseña
                            </button>
                            <button class="profile-btn secondary" onclick="enable2FA()">
                                <i class="fas fa-mobile-alt"></i> Habilitar 2FA
                            </button>
                            <button class="profile-btn secondary" onclick="managePaymentMethods()">
                                <i class="fas fa-credit-card"></i> Gestionar Pagos
                            </button>
                        </div>
                    </div>

                    <!-- Support Tab -->
                    <div id="tab-support" class="tab-content">
                        <!-- Support Header -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px;">
                            <div>
                                <h3 style="font-size: 24px; font-weight: 700; color: #1e293b; margin-bottom: 5px;">Centro de Soporte</h3>
                                <p style="color: #64748b; font-size: 14px;">Crea tickets y gestiona tus consultas</p>
                            </div>
                            <button class="profile-btn primary" onclick="openNewTicketModal()">
                                <i class="fas fa-plus"></i> Crear Ticket
                            </button>
                        </div>

                        <!-- Support Stats -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 30px;">
                            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; text-align: center; border-left: 4px solid #ff8559;">
                                <div style="font-size: 28px; font-weight: 700; color: #ff8559; margin-bottom: 8px;" id="support-total-tickets">0</div>
                                <div style="font-size: 13px; color: #64748b; font-weight: 500;">Tickets Totales</div>
                            </div>
                            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; text-align: center; border-left: 4px solid #f59e0b;">
                                <div style="font-size: 28px; font-weight: 700; color: #f59e0b; margin-bottom: 8px;" id="support-open-tickets">0</div>
                                <div style="font-size: 13px; color: #64748b; font-weight: 500;">Abiertos</div>
                            </div>
                            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; text-align: center; border-left: 4px solid #3b82f6;">
                                <div style="font-size: 28px; font-weight: 700; color: #3b82f6; margin-bottom: 8px;" id="support-in-progress-tickets">0</div>
                                <div style="font-size: 13px; color: #64748b; font-weight: 500;">En Proceso</div>
                            </div>
                            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; text-align: center; border-left: 4px solid #10b981;">
                                <div style="font-size: 28px; font-weight: 700; color: #10b981; margin-bottom: 8px;" id="support-resolved-tickets">0</div>
                                <div style="font-size: 13px; color: #64748b; font-weight: 500;">Resueltos</div>
                            </div>
                        </div>

                        <!-- Filters -->
                        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                            <select id="ticket-status-filter" class="form-control" style="flex: 1; min-width: 180px; max-width: 250px; font-size: 14px;" onchange="filterTickets()">
                                <option value="">Todos los estados</option>
                                <option value="open">Abiertos</option>
                                <option value="in_progress">En Proceso</option>
                                <option value="resolved">Resueltos</option>
                                <option value="closed">Cerrados</option>
                            </select>
                            <select id="ticket-category-filter" class="form-control" style="flex: 1; min-width: 180px; max-width: 250px; font-size: 14px;" onchange="filterTickets()">
                                <option value="">Todas las categorías</option>
                                <option value="pedido">Pedido</option>
                                <option value="producto">Producto</option>
                                <option value="pago">Pago</option>
                                <option value="envio">Envío</option>
                                <option value="devolucion">Devolución</option>
                                <option value="tecnico">Técnico</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>

                        <!-- Tickets List -->
                        <div id="tickets-list-container">
                            <div style="text-align: center; color: #64748b; padding: 40px;">
                                <i class="fas fa-spinner fa-spin" style="margin-right: 10px;"></i>
                                Cargando tickets...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="{{ url_for('static', filename='vendor/jquery/jquery.min.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/bootstrap/js/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/client_profile.js') }}"></script>

    <!-- New Ticket Modal -->
    <div id="newTicketModal" class="modal">
        <div class="modal-content" style="max-width: 650px; width: 90%;">
            <span class="close" onclick="closeNewTicketModal()">&times;</span>
            <h3 style="margin-bottom: 20px;">Crear Nuevo Ticket</h3>
            <form id="newTicketForm">
                <div class="form-group">
                    <label class="form-label">Asunto</label>
                    <input type="text" id="ticket-subject" class="form-control" required placeholder="Describe brevemente tu consulta" style="width: 100%;">
                </div>
                <div class="form-group">
                    <label class="form-label">Categoría</label>
                    <select id="ticket-category" class="form-control" required style="width: 100%; display: block;">
                        <option value="">Selecciona una categoría</option>
                        <option value="pedido">Pedido</option>
                        <option value="producto">Producto</option>
                        <option value="pago">Pago</option>
                        <option value="envio">Envío</option>
                        <option value="devolucion">Devolución</option>
                        <option value="tecnico">Técnico</option>
                        <option value="otro">Otro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Prioridad</label>
                    <select id="ticket-priority" class="form-control" required style="width: 100%; display: block;">
                        <option value="baja">Baja</option>
                        <option value="media" selected>Media</option>
                        <option value="alta">Alta</option>
                        <option value="urgente">Urgente</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Descripción</label>
                    <textarea id="ticket-description" class="form-control" rows="5" required placeholder="Describe tu consulta en detalle..." style="width: 100%;"></textarea>
                </div>
                <div class="form-group" style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="profile-btn secondary" onclick="closeNewTicketModal()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" class="profile-btn primary">
                        <i class="fas fa-paper-plane"></i> Crear Ticket
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Ticket Chat Modal -->
    <div id="ticketChatModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 1px solid #e2e8f0;">
                <div>
                    <h3 id="chat-ticket-subject" style="margin: 0; font-size: 20px;">Ticket #<span id="chat-ticket-id"></span></h3>
                    <p id="chat-ticket-status" style="margin: 5px 0 0 0; font-size: 14px; color: #64748b;"></p>
                </div>
                <span class="close" onclick="closeTicketChatModal()">&times;</span>
            </div>
            
            <div id="ticket-messages-container" style="flex: 1; overflow-y: auto; padding: 20px 0; max-height: 400px;">
                <div style="text-align: center; color: #64748b;">
                    <i class="fas fa-spinner fa-spin"></i> Cargando mensajes...
                </div>
            </div>
            
            <div style="border-top: 1px solid #e2e8f0; padding-top: 15px;">
                <form id="newMessageForm" style="display: flex; gap: 10px;">
                    <textarea id="message-content" class="form-control" rows="2" placeholder="Escribe tu mensaje..." required style="flex: 1;"></textarea>
                    <button type="submit" class="profile-btn primary" style="align-self: flex-end; white-space: nowrap;">
                        <i class="fas fa-paper-plane"></i> Enviar
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Password Change Modal -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('passwordModal').style.display='none'">&times;</span>
            <h3>Cambiar Contraseña</h3>
            <form id="passwordForm" action="{{ url_for('client.change_client_password') }}" method="POST">
                <div class="form-group">
                    <label for="current_password">Contraseña Actual:</label>
                    <input type="password" id="current_password" name="current_password" required>
                </div>
                <div class="form-group">
                    <label for="new_password">Nueva Contraseña:</label>
                    <input type="password" id="new_password" name="new_password" required>
                </div>
                <div class="form-group">
                    <label for="confirm_password">Confirmar Nueva Contraseña:</label>
                    <input type="password" id="confirm_password" name="confirm_password" required>
                </div>
                <button type="submit" class="btn btn-primary">Cambiar Contraseña</button>
            </form>
        </div>
    </div>
</body>
</html>